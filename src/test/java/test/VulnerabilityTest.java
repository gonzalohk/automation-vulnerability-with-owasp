package test;

import apiclient.FactoryRequest;
import io.restassured.response.Response;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

import static configuration.Conf.*;

public class VulnerabilityTest {
    String owaspServer;
    String applicationToTest;

    @Before
    public void before(){
        owaspServer = OWASP_SERVER +":"+OWASP_SERVER_PORT;
        applicationToTest = "https://todoist.com/";
    }

    @Test
    public void verifyVulnerabilityScanTest() throws InterruptedException {
        //1 Start Scan
        String scanId = startScanningOWASPZAP();
        //2 Monitoring
        monitoringStateAttack(scanId);
    }

    @After
    public void after(){

    }

    public String startScanningOWASPZAP(){
        String scanURL = String.format(API_START_SCAN_URL, owaspServer, applicationToTest);

        Response response=FactoryRequest.make("get").send(scanURL);
        response.prettyPrint();
        String scanId=response.then().extract().path("scan");
        System.out.println("ID :"+scanId);
        return scanId;
    }

    public void monitoringStateAttack(String scanId) throws InterruptedException {
        String getStateUrl = String.format(API_GET_STATE_URL,owaspServer, scanId);
        String getAlertsUrl = String.format(API_GET_ALERTS_URL,owaspServer, scanId);
        Map<String, Boolean> alertsToShow = new HashMap<String, Boolean>();

        // Progress 1% ... 100%
        String isComplete = "";
        while (!isComplete.equals("100")){
            Thread.sleep(10000);
            Response responseStatus=FactoryRequest.make("get").send(getStateUrl);
            isComplete = responseStatus.then().extract().path("status");
            System.out.println("OWASP Status : "+ isComplete+" %");

            //Alerts
            Response responseAlerts=FactoryRequest.make("get").send(getAlertsUrl);
            ArrayList<String> alertsIds = responseAlerts.then().extract().path("alertsIds");
            if (alertsIds != null && !alertsIds.isEmpty()){
                for (String alert : alertsIds){
                    if (alertsToShow.get(alert) == null){
                        alertsToShow.put(alert,false);
                    }
                }

                for (Map.Entry<String,Boolean> entry : alertsToShow.entrySet()) {
                    if (!entry.getValue()){
                        String getAlertByIdURL = String.format(API_GET_ALERT_BY_ID_URL,owaspServer, entry.getKey());
                        Response responseAlert=FactoryRequest.make("get").send(getAlertByIdURL);
                        System.out.println(responseAlert.prettyPrint());
                        alertsToShow.put(entry.getKey(),true);
                    }
                }

            }
        }
    }

}
